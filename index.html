<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë„ìˆ˜ vs ì¼ì¼ì˜ˆì•½ ìë™ ì ê²€ ë„êµ¬</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
    h2 { color: #2c3e50; }
    input[type="file"] { margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .green { color: green; font-weight: bold; }
    .red { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ë„ìˆ˜ vs ì¼ì¼ì˜ˆì•½ ìë™ ì ê²€ ë„êµ¬</h2>
  <div>
    <h3>1. ë„ìˆ˜ì˜ˆì•½ì‹œíŠ¸ ì—…ë¡œë“œ</h3>
    <input type="file" id="dosuFile" accept=".xlsx, .xls" />
  </div>
  <div>
    <h3>2. ì¼ì¼ì˜ˆì•½ ì—…ë¡œë“œ</h3>
    <input type="file" id="dailyFile" accept=".xlsx, .xls" />
  </div>
  <div id="result"></div>

<script>
let dosuData = [];
let dailyData = {};

const treatMap = {
  "ë„9": ["ë„ìˆ˜ì¹˜ë£Œ9", "ë„ìˆ˜9", "ë„9"],
  "ë„15": ["ë„ìˆ˜ì¹˜ë£Œ15", "ë„ìˆ˜15", "ë„15"],
  "ì¶©6.3": ["ì¶©ê²©íŒŒì¹˜ë£Œ6.3", "ì¶©ê²©íŒŒ6.3", "ì¶©6.3"],
  "ì¶©7": ["ì¶©ê²©íŒŒì¹˜ë£Œ7", "ì¶©ê²©íŒŒ7", "ì¶©7"],
  "ì¶©7.7": ["ì¶©ê²©íŒŒì¹˜ë£Œ7.7", "ì¶©ê²©íŒŒ7.7", "ì¶©7.7"],
  "ì¶©9": ["ì¶©ê²©íŒŒì¹˜ë£Œ9", "ì¶©ê²©íŒŒ9", "ì¶©9"],
  "ì¶©4.9": ["ì¶©ê²©íŒŒì¹˜ë£Œ4.9", "ì¶©4.9", "ì¶©ê²©íŒŒ4.9"]
};

function normalizeTime(value) {
  if (!value) return "";
  if (typeof value === "number") {
    const totalMinutes = Math.round(value * 24 * 60);
    const hh = String(Math.floor(totalMinutes / 60)).padStart(2, '0');
    const mm = String(totalMinutes % 60).padStart(2, '0');
    return `${hh}:${mm}`;
  }
  if (typeof value === "string") {
    let parts = value.trim().split(":");
    if (parts.length === 2) {
      return parts[0].padStart(2, "0") + ":" + parts[1].padStart(2, "0");
    }
  }
  return "";
}

function ì¹˜ë£Œëª…ì¹­ì¼ì¹˜(dosuTreat, dailyTreat) {
  const candidates = treatMap[dosuTreat] || [dosuTreat];
  return candidates.some(alias => dailyTreat.includes(alias));
}

function extractDosuSheet(sheet) {
  const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
  const result = [];

  for (let row = 4; row < data.length; row++) {
    let time = normalizeTime(data[row]?.[4]);
    if (!time) {
      // ë³‘í•©ëœ ì…€ ëŒ€ì‘: ìœ„ìª½ í–‰ì˜ ì‹œê°„ ì‚¬ìš©
      for (let up = row - 1; up >= 0; up--) {
        time = normalizeTime(data[up]?.[4]);
        if (time) break;
      }
    }

    for (let col = 5; col <= 11; col++) {
      const cell = data[row]?.[col];
      if (!cell || !time) continue;
      const tokens = cell.toString().split(" ");
      const chart = tokens.find(t => /^\d+$/.test(t));
      const treatRaw = tokens.find(t => !t.startsWith("#") && isNaN(t));
      if (chart && treatRaw) {
        const treat = Object.entries(treatMap).find(([_, v]) => v.includes(treatRaw))?.[0] || treatRaw;
        result.push({ì°¨íŠ¸ë²ˆí˜¸: chart.trim(), ì¹˜ë£Œëª…ì¹­: treat.trim(), ì‹œê°„: time});
      }
    }
  }

  return result;
}

function parseDailyMemo(memo) {
  if (typeof memo !== "string") return [];
  const matches = [...memo.matchAll(/([ê°€-í£0-9.]+)\s*\((\d{1,2}:\d{2})\)/g)];
  return matches.map(m => {
    const treat = Object.entries(treatMap).find(([_, vals]) => vals.includes(m[1]))?.[0] || m[1];
    return {ì¹˜ë£Œëª…ì¹­: treat, ì‹œê°„: normalizeTime(m[2])};
  });
}

function extractDailySheet(sheet) {
  const data = XLSX.utils.sheet_to_json(sheet);
  const map = {};
  data.forEach(row => {
    const chart = String(row["ì°¨íŠ¸ë²ˆí˜¸"] || "").trim();
    const memo = typeof row["ë©”ëª¨"] === "string" ? row["ë©”ëª¨"] : "";
    const entries = parseDailyMemo(memo);
    if (chart && entries.length > 0) {
      map[chart] = (map[chart] || []).concat(entries);
    }
  });
  return map;
}

function compareAndRender() {
  if (dosuData.length === 0 || Object.keys(dailyData).length === 0) {
    document.getElementById("result").innerHTML = "<p>ğŸ“‚ ë‘ íŒŒì¼ ëª¨ë‘ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>";
    return;
  }

  const results = dosuData.map(row => {
    const list = dailyData[row.ì°¨íŠ¸ë²ˆí˜¸] || [];
    const match = list.some(d => 
      d.ì‹œê°„ === row.ì‹œê°„ && ì¹˜ë£Œëª…ì¹­ì¼ì¹˜(row.ì¹˜ë£Œëª…ì¹­, d.ì¹˜ë£Œëª…ì¹­)
    );
    return {...row, ìƒíƒœ: match ? "í™•ì¸" : (list.length ? "ì ê²€í•„ìš”" : "-")};
  });

  const total = results.length;
  const ok = results.filter(r => r.ìƒíƒœ === "í™•ì¸").length;
  const warn = results.filter(r => r.ìƒíƒœ === "ì ê²€í•„ìš”").length;

  let html = `
    <h3>ğŸ“Š ì ê²€ ê²°ê³¼</h3>
    <p><strong>ì´ ${total}ê±´ ì¤‘ <span class="green">í™•ì¸: ${ok}</span>ê±´ / <span class="red">ì ê²€í•„ìš”: ${warn}</span>ê±´</strong></p>
    <table>
      <thead><tr><th>ì°¨íŠ¸ë²ˆí˜¸</th><th>ì¹˜ë£Œëª…ì¹­</th><th>ì‹œê°„</th><th>ìƒíƒœ</th></tr></thead>
      <tbody>
  `;

  results.forEach(r => {
    html += `
      <tr>
        <td>${r.ì°¨íŠ¸ë²ˆí˜¸}</td>
        <td>${r.ì¹˜ë£Œëª…ì¹­}</td>
        <td>${r.ì‹œê°„}</td>
        <td class="${r.ìƒíƒœ === "í™•ì¸" ? "green" : r.ìƒíƒœ === "ì ê²€í•„ìš”" ? "red" : ""}">${r.ìƒíƒœ}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  document.getElementById("result").innerHTML = html;
}

document.getElementById("dosuFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, {type: 'binary'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    dosuData = extractDosuSheet(sheet);
    compareAndRender();
  };
  reader.readAsBinaryString(e.target.files[0]);
});

document.getElementById("dailyFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, {type: 'binary'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    dailyData = extractDailySheet(sheet);
    compareAndRender();
  };
  reader.readAsBinaryString(e.target.files[0]);
});
</script>
</body>
</html>

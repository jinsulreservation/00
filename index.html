
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>도수 vs 일일예약 비교 도구</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
    h1 { color: #2c3e50; }
    input { margin-bottom: 10px; }
    .result { margin-top: 20px; white-space: pre-wrap; background: #f5f5f5; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>도수 vs 일일예약 비교 도구</h1>

  <div>
    <label>① 도수예약시트 업로드: </label>
    <input type="file" id="dossuFile" accept=".xlsx,.xls" />
  </div>
  <div>
    <label>② 일일예약 업로드: </label>
    <input type="file" id="dailyFile" accept=".xlsx,.xls" />
  </div>
  <button onclick="processFiles()">비교 실행</button>

  <div class="result" id="output">결과 출력창</div>

  <script>
    let dossuData = [];
    let dailyMemoList = [];

    function readExcelFile(file, callback) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
        callback(sheet);
      };
      reader.readAsArrayBuffer(file);
    }

    function processFiles() {
      const dossuFile = document.getElementById('dossuFile').files[0];
      const dailyFile = document.getElementById('dailyFile').files[0];
      if (!dossuFile || !dailyFile) {
        alert('두 파일을 모두 업로드해주세요.');
        return;
      }

      readExcelFile(dossuFile, dossuSheet => {
        readExcelFile(dailyFile, dailySheet => {
          parseDossuSheet(dossuSheet);
          parseDailySheet(dailySheet);
          compareData();
        });
      });
    }

    function parseDossuSheet(sheet) {
      dossuData = [];
      for (let row of sheet) {
        if (!row[0]) continue;
        const time = (row[0] + '').trim(); // E열
        const chartNo = row.find(cell => typeof cell === 'string' && /^\d{4}$/.test(cell)); // 4자리 숫자
        const count = row.find(cell => typeof cell === 'string' && /#\d+/.test(cell));
        const treat = row.find(cell => typeof cell === 'string' && /도|충|기/.test(cell));
        const staff = row.find(cell => typeof cell === 'string' && /^[가-힣]{2,}$/.test(cell));
        if (time && chartNo && treat && staff) {
          dossuData.push({ time, chartNo, treat, staff });
        }
      }
    }

    function parseDailySheet(sheet) {
      dailyMemoList = [];
      const memoColIndex = sheet[0].findIndex(h => h.toString().includes("메모") || h.toString().includes("예약"));
      for (let i = 1; i < sheet.length; i++) {
        const row = sheet[i];
        if (memoColIndex >= 0 && row[memoColIndex]) {
          dailyMemoList.push(row[memoColIndex].toString());
        }
      }
    }

    function compareData() {
      let output = "";
      let matched = 0;
      let unmatched = 0;

      for (let dossu of dossuData) {
        const match = dailyMemoList.find(memo =>
          memo.includes(dossu.chartNo) &&
          memo.includes(dossu.treat) &&
          memo.includes(dossu.staff) &&
          memo.includes(`(${dossu.time})`)
        );
        if (match) {
          output += `✅ 확인됨: ${dossu.time} ${dossu.chartNo} ${dossu.treat} ${dossu.staff}\n`;
          matched++;
        } else {
          output += `❌ 미확인: ${dossu.time} ${dossu.chartNo} ${dossu.treat} ${dossu.staff}\n`;
          unmatched++;
        }
      }

      output += `\n총 ${dossuData.length}건 중 확인: ${matched}건 / 미확인: ${unmatched}건`;
      document.getElementById("output").innerText = output;
    }
  </script>
</body>
</html>

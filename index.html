<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>도수 & 일일예약 파싱 도구</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
    h1 { color: #2c3e50; }
    input[type="file"] { margin: 5px 0; }
    button { padding: 8px 16px; margin-top: 10px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    .section { margin-top: 40px; }
  </style>
</head>
<body>
  <h1>도수 & 일일예약 파싱 도구</h1>

  <div>
    <label>도수 파일: <input type="file" id="dosuFile" accept=".xlsx" /></label><br />
    <label>일일예약 파일: <input type="file" id="reserveFile" accept=".xlsx" /></label><br />
    <button onclick="processFiles()">진행</button>
  </div>

  <div class="section">
    <h2>도수.xlsx 파싱 결과</h2>
    <div id="dosuResult"></div>
    <button id="downloadDosu" style="display:none;">도수 결과 다운로드</button>
  </div>

  <div class="section">
    <h2>일일예약.xlsx 파싱 결과</h2>
    <div id="reserveResult"></div>
    <button id="downloadReserve" style="display:none;">일일예약 결과 다운로드</button>
  </div>

  <div class="section">
    <h2>비교 결과</h2>
    <div id="compareResult"></div>
    <button id="downloadCompare" style="display:none;">비교 결과 다운로드</button>
  </div>

  <script>
    const keywords = [
      "도수치료9","도수9","도9",
      "도수치료15","도수15","도15",
      "충격파치료6.3","충격파6.3","충6.3",
      "충격파치료7","충격파7","충7",
      "충격파치료7.7","충격파7.7","충7.7",
      "충격파치료9","충격파9","충9"
    ];

    function normalizeText(text) {
      return text.replace(/\s+/g, '').replace(/\(.+?\)/g, '').trim();
    }

    function simplifyName(name) {
      return name ? name.replace(/[^가-힣]/g, '') : '';
    }

    function parseDosu(sheet) {
      const data = XLSX.utils.sheet_to_json(sheet, {header:1, raw:false});
      const results = [];
      data.forEach(row => {
        const time = row[0] || row[4];
        row.forEach(cell => {
          if (typeof cell === "string" && cell.includes("#") && (cell.includes("\n") || cell.includes("\r"))) {
            const lines = cell.split(/\r?\n/);
            let upper = "", lower = "";
            lines.forEach(line => {
              if (line.includes("#")) upper = line.trim();
              else lower = line.trim();
              if (upper && lower) {
                const m1 = upper.match(/(\d+)([가-힣]+)#?(\d+)/);
                const m2 = lower.match(/(도수?\d*\.?\d*|도\d*\.?\d*|충\d*\.?\d*)\s*([가-힣A-Za-z()]+)/);
                if (m1 && m2) {
                  const rawTherapist = m2[2].split(/[()]/)[0];
                  results.push({
                    chart: m1[1],
                    name: m1[2],
                    time: time,
                    count: "#"+m1[3],
                    treatment: m2[1].replace(" ", ""),
                    therapist: simplifyName(rawTherapist)
                  });
                }
              }
            });
          }
        });
      });
      return results;
    }

    function parseReserve(sheet) {
      const data = XLSX.utils.sheet_to_json(sheet, {header:1, raw:false});
      const map = {};
      const list = [];
      data.forEach(row => {
        const chart = row[3];
        const memo = row[10];
        if (!chart || !memo) return;
        const norm = normalizeText(memo);
        if (keywords.some(k => norm.includes(normalizeText(k)))) {
          let matches = [...memo.matchAll(/([가-힣0-9.]+)\s*\(?([0-9]{1,2}:[0-9]{2})?\)?\s*([가-힣A-Za-z()]+)/g)];
          matches.forEach(m => {
            const treatment = normalizeText(m[1]);
            if (!keywords.some(k => normalizeText(k) === treatment)) return;
            const time = m[2] || '';
            const therapist = simplifyName(m[3].split(/[()]/)[0]);
            const item = { chart, treatment, time, therapist };
            if (!map[chart]) map[chart] = [];
            map[chart].push(item);
            list.push(item);
          });
        }
      });
      return { map, list };
    }

    function compareData(dosuList, reserveMap) {
      const results = [];
      dosuList.forEach(dosu => {
        const reserveList = reserveMap[dosu.chart] || [];
        let match = reserveList.find(r =>
          normalizeText(r.treatment) === normalizeText(dosu.treatment) &&
          normalizeText(r.time) === normalizeText(dosu.time) &&
          simplifyName(r.therapist) === simplifyName(dosu.therapist)
        );

        const status = match ? "✅ 일치" : (reserveList.length ? "⚠ 불일치" : "❌ 미등록됨");
        results.push([
          dosu.chart, dosu.name, dosu.time, dosu.treatment, dosu.therapist,
          reserveList[0]?.time || '',
          reserveList[0]?.treatment || '',
          reserveList[0]?.therapist || '',
          status
        ]);
      });
      return results;
    }

    function createTable(headers, rows) {
      let html = '<table><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
      rows.forEach(r => {
        html += '<tr>' + r.map(c => `<td>${c||''}</td>`).join('') + '</tr>';
      });
      html += '</tbody></table>';
      return html;
    }

    function exportToExcel(data, headers, filename) {
      const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "결과");
      XLSX.writeFile(wb, filename);
    }

    function processFiles() {
      const dosuFile = document.getElementById('dosuFile').files[0];
      const reserveFile = document.getElementById('reserveFile').files[0];
      if (!dosuFile || !reserveFile) {
        alert("두 파일 모두 업로드하세요.");
        return;
      }

      const reader1 = new FileReader();
      reader1.onload = (e1) => {
        const data1 = new Uint8Array(e1.target.result);
        const wb1 = XLSX.read(data1, {type:'array'});
        const dosuSheet = wb1.Sheets[wb1.SheetNames[0]];
        const dosuParsed = parseDosu(dosuSheet);
        const dosuTable = dosuParsed.map(d => [d.time, d.chart, d.name, d.count, d.treatment, d.therapist]);
        const dosuHeaders = ['시간','차트번호','성함','회차','치료명칭','담당자'];
        document.getElementById('dosuResult').innerHTML = createTable(dosuHeaders, dosuTable);
        document.getElementById('downloadDosu').style.display = 'inline-block';
        document.getElementById('downloadDosu').onclick = () => exportToExcel(dosuTable, dosuHeaders, '도수결과.xlsx');

        const reader2 = new FileReader();
        reader2.onload = (e2) => {
          const data2 = new Uint8Array(e2.target.result);
          const wb2 = XLSX.read(data2, {type:'array'});
          const reserveSheet = wb2.Sheets[wb2.SheetNames[0]];
          const { map: reserveMap, list: reserveList } = parseReserve(reserveSheet);

          const reserveTable = reserveList.map(d => [d.chart, d.treatment, d.time, d.therapist]);
          const reserveHeaders = ['차트번호','치료명칭','시간','담당자'];
          document.getElementById('reserveResult').innerHTML = createTable(reserveHeaders, reserveTable);
          document.getElementById('downloadReserve').style.display = 'inline-block';
          document.getElementById('downloadReserve').onclick = () => exportToExcel(reserveTable, reserveHeaders, '일일예약결과.xlsx');

          const compare = compareData(dosuParsed, reserveMap);
          const compareHeaders = ['차트번호','성함','시간(도수)','치료명칭(도수)','담당자(도수)','일일예약 시간','일일예약 치료명칭','일일예약 담당자','상태'];
          document.getElementById('compareResult').innerHTML = createTable(compareHeaders, compare);
          document.getElementById('downloadCompare').style.display = 'inline-block';
          document.getElementById('downloadCompare').onclick = () => exportToExcel(compare, compareHeaders, '비교결과.xlsx');
        };
        reader2.readAsArrayBuffer(reserveFile);
      };
      reader1.readAsArrayBuffer(dosuFile);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>도수 vs 일일예약 자동 점검 도구</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
    h2 { color: #2c3e50; }
    input[type="file"] { margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .green { color: green; font-weight: bold; }
    .red { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>도수 vs 일일예약 자동 점검 도구</h2>
  <div>
    <h3>1. 도수예약시트 업로드</h3>
    <input type="file" id="dosuFile" accept=".xlsx, .xls" />
  </div>
  <div>
    <h3>2. 일일예약 업로드</h3>
    <input type="file" id="dailyFile" accept=".xlsx, .xls" />
  </div>
  <div id="result"></div>

<script>
let dosuData = [];
let dailyData = [];

const treatMap = {
  "도9": ["도수치료9", "도수9", "도9"],
  "도15": ["도수치료15", "도수15", "도15"],
  "충6.3": ["충격파치료6.3", "충격파6.3", "충6.3"],
  "충7": ["충격파치료7", "충격파7", "충7"],
  "충7.7": ["충격파치료7.7", "충격파7.7", "충7.7"],
  "충9": ["충격파치료9", "충격파9", "충9"]
};

function normalizeTime(time) {
  if (!time || typeof time !== "string") return "";
  const clean = time.trim();
  if (!/^\d{1,2}:\d{2}$/.test(clean)) return "";
  return clean.length === 4 ? "0" + clean : clean;
}

function findTopTime(data, row) {
  for (let r = row; r >= 0; r--) {
    const t = data[r]?.[4];
    if (t && typeof t === "string" && t.includes(":")) {
      return normalizeTime(t);
    }
  }
  return "";
}

function extractDosuSheet(sheet) {
  const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
  const result = [];
  for (let col = 5; col <= 11; col++) {
    for (let row = 4; row < data.length; row++) {
      const cell = data[row]?.[col];
      if (!cell) continue;
      const time = findTopTime(data, row);
      if (!time) continue;
      const tokens = cell.toString().split(" ");
      const chart = tokens.find(t => /^\d+$/.test(t));
      const treat = tokens.find(t => !t.startsWith("#") && isNaN(t));
      if (chart && treat) {
        result.push({차트번호: chart.trim(), 치료명칭: treat.trim(), 시간: time});
      }
    }
  }
  return result;
}

function parseDailyMemo(memo) {
  if (typeof memo !== "string") return [];
  const matches = [...memo.matchAll(/([가-힣0-9.]+)\s*\((\d{1,2}:\d{2})\)/g)];
  return matches.map(m => {
    const treat = Object.entries(treatMap).find(([_, vals]) => vals.includes(m[1]))?.[0] || m[1];
    return {치료명칭: treat, 시간: normalizeTime(m[2])};
  });
}

function extractDailySheet(sheet) {
  const data = XLSX.utils.sheet_to_json(sheet);
  const map = {};
  data.forEach(row => {
    const chart = String(row["차트번호"] || "").trim();
    const memo = typeof row["메모"] === "string" ? row["메모"] : "";
    const entries = parseDailyMemo(memo);
    if (chart && entries.length > 0) {
      map[chart] = (map[chart] || []).concat(entries);
    }
  });
  return map;
}

function compareAndRender() {
  const container = document.getElementById("result");
  if (dosuData.length === 0 || Object.keys(dailyData).length === 0) {
    container.innerHTML = "<p>파일을 모두 업로드해주세요.</p>";
    return;
  }

  const results = dosuData.map(row => {
    const list = dailyData[row.차트번호] || [];
    const match = list.some(d => d.치료명칭 === row.치료명칭 && d.시간 === row.시간);
    return {...row, 상태: match ? "확인" : (list.length ? "점검필요" : "-")};
  });

  const total = results.length;
  const ok = results.filter(r => r.상태 === "확인").length;
  const warn = results.filter(r => r.상태 === "점검필요").length;

  let html = `
    <h3>점검 결과</h3>
    <p><strong>총 ${total}건 중 확인: ${ok}건 / 점검필요: ${warn}건</strong></p>
    <table>
      <thead><tr><th>차트번호</th><th>치료명칭</th><th>시간</th><th>상태</th></tr></thead>
      <tbody>
  `;

  results.forEach(r => {
    html += `
      <tr>
        <td>${r.차트번호}</td>
        <td>${r.치료명칭}</td>
        <td>${r.시간}</td>
        <td class="${r.상태 === "확인" ? "green" : r.상태 === "점검필요" ? "red" : ""}">${r.상태}</td>
      </tr>
    `;
  });

  html += "</tbody></table>";
  container.innerHTML = html;
}

document.getElementById("dosuFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, {type: 'binary'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    dosuData = extractDosuSheet(sheet);
    compareAndRender();
  };
  reader.readAsBinaryString(e.target.files[0]);
});

document.getElementById("dailyFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, {type: 'binary'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    dailyData = extractDailySheet(sheet);
    compareAndRender();
  };
  reader.readAsBinaryString(e.target.files[0]);
});
</script>
</body>
</html>

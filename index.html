<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>도수 vs 일일예약 자동 점검 도구</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
    h2 { color: #2c3e50; }
    input[type="file"] { margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .green { color: green; font-weight: bold; }
    .red { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>도수 vs 일일예약 자동 점검 도구</h2>
  <div>
    <h3>1. 도수예약시트 업로드</h3>
    <input type="file" id="dosuFile" accept=".xlsx, .xls" />
  </div>
  <div>
    <h3>2. 일일예약 업로드</h3>
    <input type="file" id="dailyFile" accept=".xlsx, .xls" />
  </div>
  <div id="result"></div>
<script>
let dosuData = [];
let dailyData = {};

const treatMap = {
  "도9": ["도수치료9", "도수9", "도9"],
  "도15": ["도수치료15", "도수15", "도15"],
  "충6.3": ["충격파치료6.3", "충격파6.3", "충6.3"],
  "충7": ["충격파치료7", "충격파7", "충7"],
  "충7.7": ["충격파치료7.7", "충격파7.7", "충7.7"],
  "충9": ["충격파치료9", "충격파9", "충9"]
};

function normalizeTime(time) {
  if (!time) return "";
  if (typeof time === "string") {
    const parts = time.trim().split(":");
    if (parts.length === 2) {
      return parts.map(t => t.padStart(2, "0")).join(":");
    }
  }
  if (typeof time === "number") {
    const minutes = Math.round(time * 24 * 60);
    const hh = String(Math.floor(minutes / 60)).padStart(2, '0');
    const mm = String(minutes % 60).padStart(2, '0');
    return `${hh}:${mm}`;
  }
  return "";
}

function extractDosuSheet(sheet) {
  const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
  const result = [];
  for (let col = 5; col <= 11; col++) {
    for (let row = 4; row < data.length; row++) {
      const cell = data[row]?.[col];
      const rawTime = data[row]?.[4];
      const time = normalizeTime(rawTime);
      if (!cell || !time) continue;
      const tokens = cell.toString().split(/[\s\n]+/);
      const chart = tokens.find(t => /^\d+$/.test(t));
      const treat = tokens.find(t => !t.startsWith("#") && isNaN(t));
      if (chart && treat) {
        result.push({차트번호: chart.trim(), 치료명칭: treat.trim(), 시간: time});
      }
    }
  }
  return result;
}

function parseDailyMemo(memo) {
  if (typeof memo !== "string") return [];
  const matches = [...memo.matchAll(/([가-힣0-9.]+)\s*\((\d{1,2}:\d{2})\)/g)];
  return matches.map(m => {
    const raw = m[1];
    const time = m[2];
    const treat = Object.entries(treatMap).find(([_, vals]) => vals.includes(raw))?.[0] || raw;
    return {치료명칭: treat, 시간: normalizeTime(time)};
  });
}

function extractDailySheet(sheet) {
  const data = XLSX.utils.sheet_to_json(sheet);
  const map = {};
  data.forEach(row => {
    const chart = String(row["차트번호"] || "").trim();
    const memo = typeof row["메모"] === "string" ? row["메모"] : "";
    const entries = parseDailyMemo(memo);
    if (chart && entries.length > 0) {
      map[chart] = (map[chart] || []).concat(entries);
    }
  });
  return map;
}

function compareAndRender() {
  if (dosuData.length === 0 || Object.keys(dailyData).length === 0) return;

  const results = dosuData.map(row => {
    const dailyList = dailyData[row.차트번호] || [];
    const match = dailyList.some(d => 
      normalizeTime(d.시간) === normalizeTime(row.시간) &&
      (d.치료명칭 === row.치료명칭 || (treatMap[row.치료명칭]?.includes(d.치료명칭)))
    );
    return {
      차트번호: row.차트번호,
      치료명칭: row.치료명칭,
      시간: row.시간,
      상태: match ? "확인" : (dailyList.length ? "점검필요" : "-")
    };
  });

  const total = results.length;
  const ok = results.filter(r => r.상태 === "확인").length;
  const warn = results.filter(r => r.상태 === "점검필요").length;

  const html = `
    <h3>점검 결과</h3>
    <p><strong>총 ${total}건 중 확인: ${ok}건 / 점검필요: ${warn}건</strong></p>
    <table>
      <thead><tr><th>차트번호</th><th>치료명칭</th><th>시간</th><th>상태</th></tr></thead>
      <tbody>
        ${results.map(r => `
          <tr>
            <td>${r.차트번호}</td>
            <td>${r.치료명칭}</td>
            <td>${r.시간}</td>
            <td class="${r.상태 === "확인" ? "green" : r.상태 === "점검필요" ? "red" : ""}">${r.상태}</td>
          </tr>`).join("")}
      </tbody>
    </table>`;

  document.getElementById("result").innerHTML = html;
}

document.getElementById("dosuFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, {type: 'binary'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    dosuData = extractDosuSheet(sheet);
    compareAndRender();
  };
  reader.readAsBinaryString(e.target.files[0]);
});

document.getElementById("dailyFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const workbook = XLSX.read(evt.target.result, {type: 'binary'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    dailyData = extractDailySheet(sheet);
    compareAndRender();
  };
  reader.readAsBinaryString(e.target.files[0]);
});
</script>
</body>
</html>
